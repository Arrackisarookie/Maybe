{% extends "blog/article.html" %}
{% block article_body %}
<h3>2019.10.2</h3>
<p>tags 也差不多完成，接下来就是裁掉目前没什么用的地方。</p>
<p><strong>用户分级，注册，留言，api</strong></p>
<hr />
<p><strong>2019.9.30</strong>
一切的拓展都是扯淡，还是要先把基本功能给完成了。  </p>
<p><strong>主页，分类，标签，文章</strong>  </p>
<p>其他的都是扯淡空想。  </p>
<hr />
<p><strong>2019.9.28</strong></p>
<p>曾几何时，观文至感同身受，顿足捶胸，只想对文字作者说一句 <strong>你不是一个人hhh</strong>， <br />
曾何几时，寻寻觅觅，苦苦探索 N 久，终于得偿所愿找到解答，只想对大佬说句 <strong>dlnb</strong>，
曾时几何，见到傻批在装批吹牛批还喊着 mmp，只想怼他到昏天黑地日月无光，</p>
<p>可正当一腔狗血涌上心头，马上就要喷薄而出之时，</p>
<p>却怎奈！</p>
<p>要想发言，</p>
<p>得登录！要注册！</p>
<p>于是，心里只剩俩字，</p>
<p><strong>算了</strong></p>
<p>逗逼，给劳资爬开。。</p>
<p>咳咳，总之，为了在我的博客中避免这种尴尬，我决定重新构思用户分类。</p>
<p>正片</p>
<p>用户分为
掌门，长老，道友，潜在道友，芸芸众生</p>
<ul>
<li>芸芸众生<ul>
<li>所有未登记的 visitor 都是芸芸众生</li>
<li>只能浏览</li>
</ul>
</li>
<li>潜在道友<ul>
<li>只需输个名字就是潜在道友啦</li>
<li>可以点赞，留言，评论</li>
<li>想的是用 Cookie 识别身份</li>
<li>名字唯一，不可重复</li>
<li>默认 15 天不刷新 Cookie 就被标记为飞升</li>
<li>飞升不删除评论点赞留言</li>
<li>再次登记飞升道友的名字，会以 <code>名字丶第n世</code> 格式命名</li>
</ul>
</li>
<li>道友<ul>
<li>潜在道友加密码</li>
<li>身份永久</li>
</ul>
</li>
<li>长老<ul>
<li>道友的进阶版</li>
<li>管理评论留言</li>
<li>可发说说，评论说说</li>
</ul>
</li>
<li>掌门<ul>
<li>可任命道友为长老</li>
<li>最高权限</li>
<li>想干啥干啥</li>
</ul>
</li>
</ul>
<hr />
<p><strong>2019.9.26</strong>
数据库决定依旧使用 MySQL 老大哥。<br />
既然已经开始使用数据库，那么网站的整体实现就需要重新布置。  </p>
<p>网站主体中的实体主要的就这么两个:   <strong>用户, 文章</strong></p>
<p>分开细说，</p>
<h5>用户</h5>
<p><em>未注册，普通用户，管理者，管理员</em>  (<strong>权限向左兼容</strong>)  </p>
<ul>
<li>未注册可浏览文章，点赞文章</li>
<li>注册后默认为普通用户，可以留言，评论，并有权删除个人言论</li>
<li>管理者可以发布文章，操作留言，评论，操作后对相应用户进行告知</li>
<li>管理员可任命高级用户，操作用户，审核文章</li>
</ul>
<h5>文章</h5>
<p><em>以 markdown 格式存储，可在线编辑，也可上传。</em>  </p>
<p>在线编辑先不谈，大概率引其他开源项目。  </p>
<p>上传的文章
- 需要进行 meta 的设置，诸如 title，tag，category
- 可在线预览
- 需要管理员审核</p>
<p>说下 md -&gt; html  </p>
<p>文章审核通过后，会通过程序生成如下的 html</p>
<div class="codehilite"><pre><span></span>    {% block blockname %}
    ...
    <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>文章内容<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
    ...
    {% endblock %}
</pre></div>


<p>保存在如下路径中</p>
<div class="codehilite"><pre><span></span>    <span class="n">templates</span><span class="o">/</span><span class="k">generated</span><span class="o">/</span><span class="k">year</span><span class="o">/</span><span class="k">month</span><span class="o">/</span><span class="n">article_name</span>
</pre></div>


<p>然后将文件路径保存数据库中。</p>
<p><strong>附加</strong>  </p>
<p>说说和留言版<br />
这个其实也是我的执念，<br />
扣扣空间的说说和留言板确实承载了我太多的回忆，<br />
可惜时间久远物是人非了，<br />
所以就想着来个 one more time  </p>
<p>就酱~ヽ(●´∀`●)ﾉ</p>
<hr />
<p><strong>2019.9.25</strong><br />
思来想去，引入数据库做数据管理还是康庄大道，无论是 SQL 还是 NoSQL。  </p>
<p>看到用户登录的设计不是很爽，决定改之，但还是会先将文件上传搞定。<br />
在考虑是不是改回有数据库的模式，我需要读读书了。  </p>
<hr />
<p><strong>2019.9.24</strong></p>
<h5>更正</h5>
<p>我发现下面的报错不是因为 flask 多线程导致读写冲突，而是 shelve 打开文件时默认不支持更改数据</p>
<div class="codehilite"><pre><span></span>    <span class="n">shelve</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">flag</span><span class="o">=</span><span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">writeback</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</pre></div>


<p>writeback 默认为 False，即不能动态写回数据，更改为 True 上面的 error 就没了。  </p>
<p>---------------------华丽的分隔符----------------------  </p>
<p>再一次的想砸电脑。。
突然怀念起数据库的好。。
由于是静态博客，所以数据是用 shelve 存储的。我刚意识到这样的数据存储和更新是有多愚蠢。。 </p>
<h5>目前遇到的问题是:</h5>
<p>原本 yukun 大佬的设计是，每次运行 Generate 就会把资源目录里的 .md 全部重新生成一遍，我认为很浪费资源，就改了一下实现。  </p>
<p>由于 generate_article 函数会将 _article 中所有 md 全部生成 html  </p>
<p>我就在每个 md 文件生成 html 之后，将该 md 文件移动至 source 目录下的 _finished 目录中。  </p>
<p>然后，上传文件之后调用 gen() 就不会对原有 md 二次操作了。  </p>
<p>但是！  </p>
<p>这样做必须将内存中的标签，分类，文章信息全部保存在硬盘。每次上传文件就会读取这些数据，并更新他们，再根据新的数据，生成新的标签，分类，文章索引页面。  </p>
<p>按理说，用数据库的话，就是个 update 再 select 的事情，用 flask-sqlalchemy 还能保证没冲突。<br />
可是 shelve 太简单了。。他同时读写时不是线程安全的。。但 flask 多线程啊。。<br />
有读有写。。这不就崩了。。 </p>
<div class="codehilite"><pre><span></span>    <span class="n">_gdbm</span><span class="p">.</span><span class="n">error</span><span class="p">:</span> <span class="p">[</span><span class="n">Errno</span> <span class="mi">11</span><span class="p">]</span> <span class="n">Resource</span> <span class="n">temporarily</span> <span class="n">unavailable</span>  
</pre></div>


<p>这就很难受了。。我在研究一下怎么控制读写保护。。<br />
实在不行，就还是每回都重新生成吧。。  </p>
<hr />
<p><strong>2019.9.22</strong>
重构了一下 yukun 大佬的 <a href="https://github.com/blackyukun/quiet">quiet</a>，主要是改了 generate.py 这个文件。  </p>
<p>搞模板搞得要吐了，我缓缓。。明天见。。</p>
<hr />
<p><strong>2019.9.21</strong> 
两天时间，查了很多资料，看了很多别人家的代码，也尝试了很多，最后决定为本博客定义以下标签:<br />
个人，静态，markdown，Flask<br />
启发于<a href="https://github.com/blackyukun">Blackyukun</a>
yukun 大佬你的博客以后就是我的目标了 hhhh ~</p>
<hr />
<p><strong>2019.9.19</strong><br />
按照原本的构思，version 0.0.3 应该上线支持 markdown ，但在翻了一整天的别人的代码之后，发现自己对于整体框架把握一直不太清晰，对具体功能的实现也并不确定。<br />
所以我决定，仔细想一下到底要做什么，实现什么功能，需要怎样的结构，以怎样的方式来实现它们。  </p>
<p>等我归来。  </p>
<hr />
<p><strong>之前</strong><br />
当时的想法是跟着 greyli 老师的 hello Flask 将博客搭起来，基本没有自己的想法，主要也是当时什么也不太懂，不知道博客该有些什么，结构功能就很随便，人家有啥我就抄啥，也不知道抄的是啥hhhhh。<br />
后来慢慢了解到有很多种形式，比如前后端分离的，纯静态页面的，连数据库的等等。当见识的稍微多一些了，就会发现能走的路有很多条，于是就有了 9.19 的那些话。</p>
{% endblock %}
